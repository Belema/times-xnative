<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<style>
			* {
				padding: 0;
				margin: 0;
			}

			.ErrorMessage.is-hidden {
				display: none;
			}

			.ErrorMessage {
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				margin-top: 100px;

				font-family: Georgia, serif;
			}

			.ErrorMessage-Heading {
				font-size: 24px;
			}

			.ErrorMessage-Body {
				font-size: 16px;
			}
		</style>
		<script>
			// Example values:
			// ARTICLE_ID = "123";
			// ARTICLE_URL = "https://www.thetimes.co.uk/article/123";
			// SPOT_ID = "xyz123";
			// This auth header works with the dirty-spot-hack-for-bernie branch of TPA, the value of
			// the header is a user ID to log the user in as
			// AUTH_HEADER_NAME = "security_hole_user_id";
			// This user ID was manually created using the Spot backend APIs. If you want to test with new users
			// before the official ACS/Spot integration goes live, ask Bernie to manually put your CPN into Spot
			// AUTH_HEADER_VALUE = "ABC123";
			// This is the endpoint to use if you're running a local TPA instance
			// GRAPHQL_ENDPOINT = "http://localhost:4000/graphql";

			const ARTICLE_ID = window.ANDROID.getArticleId();
			const ARTICLE_URL = window.ANDROID.getArticleUrl();
			const SPOT_ID = window.ANDROID.getSpotId();
			const AUTH_HEADER_NAME = "Authorization";
			const AUTH_HEADER_VALUE = window.ANDROID.getAuthHeaderValue();
			const GRAPHQL_ENDPOINT = window.ANDROID.getGraphQlEndpoint();
			const spotIamReadyEvent = "spot-im-api-ready";

			function beginSSOTransaction() {
				window.SPOTIM.startSSO((codeA, completeSSOCallback) => {
					console.log("Received Code A", codeA);
					const query = `{
						viewer {
							spotimCodeB(codeA: ${JSON.stringify(codeA)})
						}
					}`;
					const url = `${GRAPHQL_ENDPOINT}?query=${encodeURIComponent(query)}`;
					const xhr = new XMLHttpRequest();

					xhr.addEventListener("load", () => {
						console.log("Received GraphQL response", xhr.response);
						const response = JSON.parse(xhr.response);
						const codeB = response.data.viewer.spotimCodeB;
						completeSSOCallback(codeB);
					});

					xhr.addEventListener("error", console.error);

					xhr.open("GET", url);
					xhr.setRequestHeader(AUTH_HEADER_NAME, AUTH_HEADER_VALUE);
					xhr.send();
				});
			}

			function addSpotScript () {
				const script = document.createElement("script");
				script.setAttribute("async", true);
				script.setAttribute("src", `https://launcher.spot.im/spot/${SPOT_ID}`);
				script.setAttribute("data-spotim-module", "spotim-launcher");
				script.setAttribute("onerror", "displayErrorMessage()");
				script.setAttribute("data-post-url", ARTICLE_URL);
				script.setAttribute("data-post-id", ARTICLE_ID);
				script.setAttribute("data-seo-enabled", "true");
				script.setAttribute("data-livefyre-url", ARTICLE_ID);
				document.body.appendChild(script);
			}

			function displayErrorMessage () {
				const errorMessage = document.getElementById('error-message');
				errorMessage.className = errorMessage.className.replace('is-hidden', '');
			}

			function loaded() {
				window.ANDROID.spotimLoaded();
			}

			document.addEventListener(spotIamReadyEvent, beginSSOTransaction);
			document.addEventListener(spotIamReadyEvent, loaded);

			document.addEventListener('DOMContentLoaded', addSpotScript);

			document.addEventListener('spot-im-current-user-typing-start', () => {
				window.ANDROID.track('spot im : comment : start');
			});

			document.addEventListener('spot-im-current-user-sent-message', () => {
				window.ANDROID.track('spot im : comment : complete');
			});
		</script>
	</head>
	<body>
		<div id="error-message" class="ErrorMessage is-hidden">
			<p class="ErrorMessage-Heading">
				Something went wrong.
			</p>
			<p class="ErrorMessage-Body">
				If you are not connected to the internet please reconnect and try again.
			</p>
		</div>
	</body>
</html>
