<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<style>
			* {
				padding: 0;
				margin: 0;
			}

			.ErrorMessage.is-hidden {
				display: none;
			}

			.ErrorMessage {
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				margin-top: 100px;

				font-family: Georgia, serif;
			}

			.ErrorMessage-Heading {
				font-size: 24px;
			}

			.ErrorMessage-Body {
				font-size: 16px;
			}
		</style>
		<script>
			// Example values:
			// ARTICLE_ID = "123";
			// ARTICLE_URL = "https://www.thetimes.co.uk/article/123";
			// SPOT_ID = "xyz123";
			// This auth header works with the dirty-spot-hack-for-bernie branch of TPA, the value of
			// the header is a user ID to log the user in as
			// AUTH_HEADER_NAME = "security_hole_user_id";
			// This user ID was manually created using the Spot backend APIs. If you want to test with new users
			// before the official ACS/Spot integration goes live, ask Bernie to manually put your CPN into Spot
			// AUTH_HEADER_VALUE = "ABC123";
			// This is the endpoint to use if you're running a local TPA instance
			// GRAPHQL_ENDPOINT = "http://localhost:4000/graphql";

			const ARTICLE_ID = "82bd9272-cb4a-11e4-a202-50ac5def393a";
            const ARTICLE_URL = "localhost:8000/edition/news/learning-by-rote-will-put-pupils-off-poetry-3g63xnt5l";
            const SPOT_ID = "sp_pCQgrRiN";
            const AUTH_HEADER_NAME = "security_hole_user_id";
            const AUTH_HEADER_VALUE = "ABC123";
            const GRAPHQL_ENDPOINT = "http://localhost:4000/graphql";

			/*
			var ARTICLE_ID = "%ARTICLE_ID%";
			var ARTICLE_URL = "%ARTICLE_URL%";
			var SPOT_ID = "%SPOT_ID%";
			var AUTH_HEADER_NAME = "%AUTH_HEADER_NAME%";
			var AUTH_HEADER_VALUE = "%AUTH_HEADER_VALUE%";
			var GRAPHQL_ENDPOINT = "%GRAPHQL_ENDPOINT%";
			*/

			function beginSSOTransaction() {
				window.SPOTIM.startSSO(function (codeA, completeSSOCallback) {
					console.log("Received Code A", codeA);
					var query = "{ viewer { spotimCodeB(codeA: " + JSON.stringify(codeA) + ") } }";
					var url = GRAPHQL_ENDPOINT + "?query=" + encodeURIComponent(query);
					var xhr = new XMLHttpRequest();

					xhr.addEventListener("load", function () {
						console.log("Received GraphQL response", xhr.response);
						var response = JSON.parse(xhr.response);
						var codeB = response.data.viewer.spotimCodeB;
						completeSSOCallback(codeB);
					});

					xhr.addEventListener("error", console.error);

					xhr.open("GET", url);
					xhr.setRequestHeader(AUTH_HEADER_NAME, AUTH_HEADER_VALUE);
					xhr.send();
				});
			}

			function addSpotScript() {
				var script = document.createElement("script");
				script.setAttribute("async", true);
				script.setAttribute("src", "https://launcher.spot.im/spot/" + SPOT_ID);
				script.setAttribute("data-spotim-module", "spotim-launcher");
				script.setAttribute("onerror", "displayErrorMessage()");
				script.setAttribute("data-post-url", ARTICLE_URL);
				script.setAttribute("data-post-id", ARTICLE_ID);
				script.setAttribute("data-seo-enabled", "true");
				script.setAttribute("data-livefyre-url", ARTICLE_ID);
				document.body.appendChild(script);
			}

			function displayErrorMessage() {
				var errorMessage = document.getElementById('error-message');
				errorMessage.className = errorMessage.className.replace('is-hidden', '');
			}

			document.addEventListener("spot-im-api-ready", beginSSOTransaction);

			document.addEventListener('DOMContentLoaded', addSpotScript);

			document.addEventListener('spot-im-current-user-typing-start', function () {
				window.webkit.messageHandlers.spotIMUserStartedTyping.postMessage('spot im : comment : start');
			});

			document.addEventListener('spot-im-current-user-sent-message', function () {
				window.webkit.messageHandlers.spotIMUserMessageSent.postMessage('spot im : comment : complete');
			});
		</script>
	</head>
	<body>
		<div id="error-message" class="ErrorMessage is-hidden">
			<p class="ErrorMessage-Heading">
				Something went wrong.
			</p>
			<p class="ErrorMessage-Body">
				If you are not connected to the internet please reconnect and try again.
			</p>
		</div>
	</body>
</html>
